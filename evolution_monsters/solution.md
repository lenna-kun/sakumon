# Evolution Monstersの解説

## 考察ステップ1

それぞれのモンスターを頂点とし，それぞれの進化を頂点を結ぶ有向辺（進化元から進化先の向き）で表し，進化石の値段を対応する進化の辺の重みとして表すと，問題の情報を **重み付き有向グラフ** として表すことができることがわかります．

さらに，問題文中の進化の説明から，与えられるグラフは必ず **森** であることがわかります．

よって，この問題は次のように言い換えられます．

M辺N頂点の **重み付き有向根付き森** が与えられたあとに，クエリがQ個与えられます．各クエリでは，2つの頂点P1，P2が与えられます．それぞれのクエリについて，P2がP1の子孫でない場合は `IMPOSSIBLE` ，P2がP1の子孫である場合は，P1からP2へのパスにおいてP1の次に通る頂点，および，そのパスの長さを出力しなさい．

## 考察ステップ2

したがって，解く問題は，以下の3つです．

1. 子孫判定（LCA）
2. 与えられた頂点間パス上の累積和
3. 与えられた頂点間のパス上で，始点の次に通る点

3.は少し難しいですが，1.と2.から， **Euler Tour** によって解く問題であることが推測できます．また， **Euler Tour** を頭においた状態で3.を考えると，実は3.も， **Euler Tour** に一手間加えるだけで解くことができることに気づきます．

## 考察ステップ3

入力例2を考えてみます．

```
10 7 6
20 10 3
40 5 1
30 9 4
20 10 7
30 1 6
10 5 10
40 3 2
8 10
3 4
10 6
5 7
10 2
5 9

```

入力例2では，10個の頂点と，7個の辺を持つ森に対して，6個のクエリが与えられます．

<div align="center"><img src="sample2_graph.png" width=30%></div>

便宜上，モンスター5を根とする木を木1，モンスター9を根とする木を木2と呼びます．木1と木2はそれぞれ独立して考えることができるので，まず木1について考えます．

木1において，根ノード（頂点5）からDFSをし，通過した頂点と，辺の重みを順番に記録します．（ **Euler Tour** ）ただし，有向辺の逆向きに辿った辺はマイナスの値として記録することにします．すると，以下のような配列が生成できます．

|通った時刻|0|1|2|3|4|5|6|7|8|9|10|11|12|
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
|**通った頂点**|5|1|6|1|5|10|3|2|3|10|7|10|5|
|**通った辺の重み**|-|40|30|-30|-40|10|20|40|-40|-20|20|-20|-10|
|**辺の重みの累積和**|0|40|70|40|0|10|30|70|30|10|30|10|0|

## 考察ステップ4

ここで，入力例2のクエリの1つである，P1=5, P2=7について考えてみましょう．

上の配列において，頂点5を通ったのは時刻0,4,12であり，頂点7を通ったのは時刻10です．ここから，0 < 10 < 12であるため，頂点7は頂点5の子孫であることがわかります．（あらかじめ，それぞれの頂点ごとに通った時刻を記録しておくことで，これはO(1)で求まります．）

頂点7が頂点5の子孫であることが確認できたので，次に，頂点5，頂点7間のパス上の辺の重みの合計を求めます．頂点7を通った時刻10は，頂点5を通った時刻0, 4, 12における時刻4と時刻12の間にあります．ここから，頂点5，頂点7間のパス上の辺の重みの合計は，上の配列の，辺の重みの累積和の時刻10の値30から，時刻4の値0を引いた30ということになります．また，頂点5を通った時刻が4であることから，頂点5，頂点7間のパスにおいて，頂点5の次に通る頂点は，明らかに時刻4+1であるため，頂点10ということになります．（頂点P1を通った時刻の配列から頂点P2を最初に通った時刻を2分探索することで，O(log N)で求まります．）

木2についても同様の情報を持つことで木ごとに問題を解くことができます．また，DFSをする際にそれぞれの頂点がどの木に属するかを一緒に記録しておきましょう．頂点P1と頂点P2が違う木に存在する頂点のとき，答えは明らかに `IMPOSSIBLE` です．

以上から，DFSにO(N)，辺の重みの累積和を求めるのにO(N)，Q個のクエリごとにO(log N)かかります．よって，全体の計算量はO(N + Q log N)となり，これは実行時間制限に対して十分高速です．